# 概要设计

版本：1.0

日期：2025-11-25

作者：自动生成（基于现有代码仓库）

----

**目的**：
本概要设计文件描述 `dsl-agent` 项目的整体架构、模块划分、主要接口与数据流，并给出实现细节要点和扩展建议，供后续详细设计与实现验证参考。

**范围**：
覆盖项目中的主要模块：LLM 客户端（意图识别）、DSL 引擎、示例脚本、命令行入口与测试模块；不包括演示视频与答辩材料。

----

**系统架构概览**

- 用户（命令行） → `src/main.py`（入口） → `LLMClient`（意图识别） → `DSLEngine`（脚本执行） → 返回回复给用户。
- LLM 调用为可选环节：当 LLM 无法使用时使用关键词回退逻辑。
- 脚本（`src/script.dsl`）定义场景（scene）与意图（intent），以及每个意图对应的一系列动作（reply、set、call、extract、wait_for_input 等）。

----

**模块划分与职责**

- `src/llm_client.py`：
  - 负责意图识别接口。主要类 `LLMClient` 提供 `recognize_intent(user_input, available_intents)`。
  - 支持两种模式：调用 OpenAI 兼容的客户端（实际使用外部 API）或回退到关键词匹配。可通过 `use_llm` 与 `debug` 标志控制行为。
  - 输出：字符串形式的意图名称（例如 `check_order`），若无法识别返回 `unknown`。

- `src/dsl_engine.py`：
  - 负责 DSL 脚本的加载、解析与执行（类 `DSLEngine`）。
  - 功能：解析 `config`/`var`/`function`/`scene` 块；支持动作类型：`reply`、`log`、`set`、`call`、`wait_for_input`、`wait_for_confirm`、`extract`。支持条件判断（`if/else/end`）与模板替换（随机回复、时间、随机数等）。
  - 提供外部接口：`get_intents()`（返回可用意图列表）与 `process(intent, user_input)`（执行对应意图并返回回复）。
  - 支持注册 Python 回调函数 `register_function(name, callable)`，以便在 DSL 中通过 `call` 调用扩展功能。

- `src/main.py`：
  - 程序入口。实现交互式 CLI，读取用户输入，调用 `LLMClient` 识别意图，再调用 `DSLEngine.process()` 得到回复并打印。

- `src/script.dsl`：
  - 示例脚本，包含多个 `scene` 与 `intent`，演示语法用法与常见客服流场景（问候、订单查询、退货、投诉、转人工、回退等）。

- 测试：
  - `src/test_dsl_engine.py`（单元/集成测试样例），以及 `test_dsl_engine_e2e.py`（若存在，用于端到端测试）。

----

**主要数据结构与接口**

- DSLEngine.scenes：
  - 类型：Dict[str, Dict[str, List[Action]]]
  - 说明：按场景名映射到每个意图的动作列表；Action 为三元组 `(action_type, action_value, condition_stack)`。

- DSLEngine.process(intent: str, user_input: str) -> Optional[str]
  - 说明：执行与该意图对应的动作序列并返回合并后的回复文本或默认回复。会使用内部状态（如 `waiting_for`、`variables`）来处理多轮交互。

- LLMClient.recognize_intent(user_input: str, available_intents: List[str]) -> str
  - 说明：将用户输入与可用意图列表发送到 LLM（或进行关键词匹配），返回最匹配的意图名或 `unknown`。

----

**交互流程（序列）**

1. 用户在 CLI 输入文本（`user_input`）。
2. `main.py` 调用 `LLMClient.recognize_intent(user_input, dsl_engine.get_intents())`。
3. LLMClient 返回 `intent_name`。
4. `main.py` 调用 `DSLEngine.process(intent_name, user_input)`。
5. DSLEngine 根据 `scenes` 的定义执行动作（检查条件栈、执行 `reply`/`set`/`call` 等动作），可能更新 `variables`、设置 `waiting_for`。
6. 返回文本回复并打印；若设置 `waiting_for`，下一轮用户输入可能被映射到不同的意图（例如等待订单号时直接给出订单号）。

----

**DSL 语法概览（高层）**

- 文件结构：`config`、`var`、`function`、`scene "name"`。
- 场景与意图：
  - `scene "<name>"`
  - `intent "<intent_name>"`
- 动作：
  - `reply "..."`：文本回复（支持变量替换 `$var` 与模板 `{{...}}`）。
  - `log "..."`：打印日志。
  - `set var = expr`：设置变量（支持 `$var` 引用与简单表达式）。
  - `call result = func(args)`：调用函数并将结果赋给变量。
  - `wait_for_input "type"` / `wait_for_confirm "type"`：设置等待状态。
  - `extract var from "pattern" or "pattern2"`：从用户输入提取信息（正则）。
- 条件：
  - `if <condition>` / `else` / `end`
  - 支持 `contains`（子串包含）、`matches`（正则匹配）、比较运算符 `== != > < >= <=`。

----

**配置与部署要点**

- 运行环境：推荐 Python 3.10+。
- 依赖项：可能包括 `openai`（或第三方兼容客户端）、`pytest` 等。建议生成 `requirements.txt`。
- API Key：`LLMClient` 支持通过环境变量 `DSL_AGENT_API_KEY` 读取 API Key。必须在文档中明确配置步骤，禁止直接硬编码密钥。
- 日志：当前使用 `print` 打印日志，建议在后续改为 `logging` 模块，便于调整日志级别与导出。

----

**扩展点与可改进项**

- 语法解析：当前为行解析，建议实现更稳健的解析器（例如基于解析表达式或使用 `ply` / `lark` 等库），以更好支持字符串转义与复杂表达式。
- LLM 集成：将 `base_url`、`model`、`timeout` 等参数外部化为配置项；增加请求重试与超时控制；明确错误上报与回退策略。
- 多轮管理：当前通过 `waiting_for` 与意图映射实现简单多轮，建议引入会话对象（Session）来记录用户上下文、历史消息与会话过期策略。
- 安全与私密性：对用户输入与外部 API 的传输需注意隐私，日志中不应直接打印敏感信息（例如订单号或 API Key）。

----

**测试策略**

- 单元测试：覆盖条件判断、变量替换、模板处理、函数调用、信息提取等核心功能（`src/test_dsl_engine.py` 的方向正确）。
- 端到端测试：模拟对话流（推荐使用自动化脚本驱动 `main.py` 的输入/输出或直接调用 `DSLEngine`）。
- CI：建议添加 GitHub Actions 工作流，在 Push/PR 时运行 `pytest`。

----

**已知限制（当前实现）**

- 解析器对复杂字符串和边界情形支持有限（例如嵌套引号、复杂参数带逗号的解析可能出错）。
- LLM 客户端代码包含硬编码的回退 key，应移除并仅依赖环境变量。
- 日志使用 `print`，不利于正式运行时排错与审计。

----

**后续交付建议（与需求对应）**

1. 生成并提交 `docs/详细设计.md`，包括关键类与函数说明、内部数据结构、示例调用序列（代码片段）。
2. 生成 `docs/DSL_指南.md`，作为学生提交的 DSL 手册。包含语法、示例与常见错误排查。
3. 运行测试并生成 `docs/测试报告.md`（包含 pytest 输出）。
4. 生成 `docs/GIT日志.txt`（导出 `git log`）。

----

**结语**

该概要设计为仓库现状的草稿级文档。若你同意，我可以继续生成 `docs/详细设计.md`（下一步），或先按你的优先级完成 `DSL_指南.md` / `测试报告.md` 等文件。


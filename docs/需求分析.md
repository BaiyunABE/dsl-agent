# 需求分析（映射到现有仓库）

版本：1.0

作者：自动生成（由仓库代码检查结果整理）

日期：2025-11-25

----

## 一、任务背景

根据 `request.md` 的要求，需要设计并实现一门用于描述客服机器人应答逻辑的脚本语言（DSL）及其解释器，使用开放 API 的 LLM 做意图识别，并提交完整的项目交付物（代码、设计文档、测试报告、DSL 指南、GIT 日志、演示视频和答辩 PPT 等）。

本文件将把 `request.md` 的每一项需求与当前仓库（`src/`）进行对应评估，指出已实现、部分实现或未实现的项，并给出建议与优先级。

----

## 二、需求逐项映射与评估

- 需求：语法自定义，语义上满足描述客服机器人自动应答逻辑的要求
  - 状态：已实现（满足）
  - 证据：`src/script.dsl` 提供了完整且丰富的 DSL 示例；`src/dsl_engine.py` 实现了脚本解析与执行逻辑（支持 `scene`/`intent`、`reply`、`set`、`call`、`if/else/end`、`extract`、`wait_for_input` 等语法元素）。
  - 说明：引擎支持条件判断、变量替换、模板、函数调用、信息提取与等待机制。

- 需求：自行给出不同脚本范例
  - 状态：已实现（满足）
  - 证据：`src/script.dsl` 是一个包含多个场景（主场景、时间服务、订单管理、客服支持、回退、系统等）的示例脚本。

- 需求：选用一种开放 API 的 LLM，调用 API 对用户输入进行意图识别
  - 状态：部分实现（需确认/配置）
  - 证据：`src/llm_client.py` 实现了对 OpenAI 兼容客户端（导入 `from openai import OpenAI`）的调用，封装了 `recognize_intent()`。代码中也包含回退的关键词匹配逻辑。
  - 风险/注意点：文件中存在硬编码“回退 key”（建议移除）；`base_url` 指向特定供应商（`ark.cn-beijing.volces.com`），需要确认是否为开放 API 或使用者是否有权限/凭证；运行时需通过环境变量配置 API Key（建议在文档中明确）。

- 需求：IO 形式不限（可以命令行）
  - 状态：已实现（满足）
  - 证据：`src/main.py` 提供交互式命令行循环，调用 LLM 识别意图并让 DSL 引擎处理。

- 需求：开发环境、工具（yacc/lex 可选，大模型辅助可行）
  - 状态：无具体约束（已满足）
  - 说明：实现使用 Python 纯解析，没有使用 yacc/lex（也不强制要求）。可使用大模型辅助开发（不影响提交）。

- 需求：必须使用 git 进行版本管理
  - 状态：无法通过文件内容完全验证，但仓库上下文显示存在 `main` 分支，说明已使用 Git。
  - 建议：导出并收集 `git log` 作为提交物的一部分。


----

## 三、对 request.md 列出提交物的映射

- 项目全部代码
  - 状态：满足。代码位于 `src/`。请确认是否包含所有运行需要的第三方依赖（建议生成 `requirements.txt`）。

- 项目文档.pdf
  - 状态：缺失。当前仓库有 `README.md`（已改为中文），但没有 PDF 文档。需要把需求分析、设计文档、DSL 指南等合并并导出为 `项目文档.pdf`（或 `project_documentation.pdf`）。

- 需求分析
  - 状态：缺失（当前即补充该文件 `docs/需求分析.md`）。

- 概要设计
  - 状态：缺失。建议在 `docs/概要设计.md` 中说明系统组件（LLM 客户端、DSL 引擎、脚本示例、CLI）、模块间交互、数据格式与接口契约（例如：`recognize_intent()` 的输入/输出、`DSLEngine.process()` 的语义）。

- 详细设计
  - 状态：缺失。建议在 `docs/详细设计.md` 中给出关键类与函数说明、脚本语法规范（BNF/示例规则）、错误处理策略与扩展点。

- 测试报告
  - 状态：部分（测试用例存在，但无书面报告）。
  - 证据：`src/test_dsl_engine.py` 与 `src/test_dsl_engine_e2e.py`（后者存在于仓库根目录）。
  - 建议：运行 `pytest` 并把输出保存为 `docs/测试报告.md`（或 `测试报告.pdf`），列出通过/失败测试、覆盖范围与已知问题。

- DSL 编写指南
  - 状态：部分（`script.dsl` 可作为示例，但没有专门的语言手册）。
  - 建议：编写 `docs/DSL_指南.md`，包含语法说明、指令合集、表达式语法、变量/模板用法、示例与调试技巧。

- AI 相关（说明如何配置/使用 LLM）
  - 状态：部分（`llm_client.py` 有实现与注释）
  - 建议：编写 `docs/AI_使用说明.md`，清晰说明需要的环境变量（例如 `DSL_AGENT_API_KEY`）、如何获得 API key、如何切换到关键词回退模式、以及隐私/安全考量。

- GIT 日志
  - 状态：缺失（作为交付物需导出）。
  - 建议：运行 `git log --oneline --decorate --stat > docs/GIT日志.txt` 并包含在提交包中。

- 视频文件（演示主要功能并讲解）
  - 状态：缺失。建议准备 3–5 分钟录屏，演示 CLI 对话、脚本修改与再次运行、测试运行结果，并旁白或字幕说明关键实现点。

- 答辩 PPT
  - 状态：缺失。建议准备 10–15 页 PPT，包含需求、架构、实现要点、演示截图/视频链接、测试结果与未来工作。


----

## 四、优先级建议与实施步骤（短期到中期）

下面按优先级给出可执行任务，方便尽快把仓库扩展为可交付的完整作业包。

1. 必做（短期，建议优先）
   - **生成 `requirements.txt`**：扫描 `src/` imports（如 `openai`、`pytest`）并生成文件。预计工作量：15–30 分钟。
   - **移除或替换 `llm_client.py` 中的硬编码 API key**：仅从环境变量读取并在 README/文档中说明如何配置。预计工作量：15–30 分钟。
   - **补齐文档：需求分析（已完成）、概要设计、DSL 指南、测试报告草稿**：将这些 Markdown 文件放入 `docs/`。预计工作量：2–4 小时（草稿级）。
   - **导出 `git log` 到 `docs/GIT日志.txt`**。预计工作量：< 15 分钟。

2. 次要（中期）
   - **运行测试并生成测试报告**（包括 pytest 输出和关键截图）。预计工作量：30–60 分钟。
   - **将 Markdown 导出为 PDF（`项目文档.pdf`）**，使用 `pandoc` 或本地工具。预计工作量：15–30 分钟（若本地环境已有 pandoc）。

3. 可选（演示与答辩材料）
   - **准备演示视频**（录屏 CLI 演示并讲解）。预计工作量：30–60 分钟录制 + 20–40 分钟剪辑。
   - **制作答辩 PPT**（基于概要设计与测试结果）。预计工作量：1–2 小时。


----

## 五、建议改进（代码层面）

- `llm_client.py`：移除硬编码 key；在初始化失败时给出更友好的提示与文档链接；将 `base_url` 和 `model` 放入配置（`config` 或环境变量）。
- `dsl_engine.py`：目前解析实现基于行解析，建议补充语法文档并对 edge case（如字符串中含 `"`、复杂参数、嵌套条件）增加更完善的解析测试。
- 增加日志/调试选项（例如使用 `logging` 模块）以便在测试与录制演示时更好地追踪行为。


----

## 六、如何把这些文档导出为 PDF（快速命令）

以下示例适用于有 `pandoc` 的环境。在 PowerShell 中运行：

```powershell
# 把多个 Markdown 合并并导出为 PDF
pandoc docs\需求分析.md docs\概要设计.md docs\详细设计.md docs\测试报告.md docs\DSL_指南.md -o 项目文档.pdf
```

如果没有 `pandoc`，也可以把 Markdown 用 GitHub 渲染并在浏览器中打印为 PDF，或用 Typora/MarkText 等工具导出。

----

## 七、我推荐的下一步（我可以代办）

- 生成并提交以下文件到仓库 `docs/`：
  - `概要设计.md`
  - `详细设计.md`
  - `DSL_指南.md`
  - `测试报告.md`（包含 pytest 输出）
  - `GIT日志.txt`

如果你同意，我会先自动生成 `docs/概要设计.md`（草稿）并提交；请确认是否开始。

----

## 八、附录：关键源码位置速览

- DSL 引擎：`src/dsl_engine.py`
- LLM 客户端：`src/llm_client.py`
- 示例脚本：`src/script.dsl`
- CLI 入口：`src/main.py`
- 单元测试：`src/test_dsl_engine.py`
- 端到端测试：`src/test_dsl_engine_e2e.py`


----

（结束）
